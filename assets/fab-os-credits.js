const FabOsCredits=(()=>{const cache={value:null,ts:0},baseUrl="/apps/fab-os/proxy";const showModal=()=>{const m=document.getElementById("fab-os-credits-modal");if(m)m.classList.add("is-open")};const hideModal=()=>{const m=document.getElementById("fab-os-credits-modal");if(m)m.classList.remove("is-open")};const updateBadge=(b)=>{const badge=document.getElementById("fab-os-credits-badge");if(badge)badge.textContent=String(b)};const getEntitlements=async()=>{const now=Date.now();if(cache.value&&now-cache.ts<30000)return cache.value;const res=await fetch(`${baseUrl}/entitlements`);if(!res.ok)throw new Error("entitlements failed");const json=await res.json();cache.value=json;cache.ts=now;return json};const runWithCredits=async(cost,tool,fn)=>{try{const res=await fetch(`${baseUrl}/credits/deduct`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cost,tool,run_id:crypto.randomUUID()})});if(res.status===409){showModal();return}if(!res.ok)throw new Error("deduct failed");const data=await res.json();updateBadge(data.balance_after);await fn()}catch{document.querySelectorAll("[data-credit-tool]").forEach((el)=>el.setAttribute("disabled","disabled"))}};const bindButtons=async()=>{try{const{balance}=await getEntitlements();updateBadge(balance);document.querySelectorAll("[data-credit-tool]").forEach((el)=>{const cost=Number(el.getAttribute("data-credit-cost"));if(balance<cost)el.setAttribute("disabled","disabled");el.addEventListener("click",(event)=>{event.preventDefault();runWithCredits(cost,el.getAttribute("data-credit-tool"),async()=>{const handler=el.getAttribute("data-credit-handler");if(handler&&window[handler])await window[handler]()})})})}catch{document.querySelectorAll("[data-credit-tool]").forEach((el)=>el.setAttribute("disabled","disabled"))}};return{getEntitlements,runWithCredits,bindButtons,hideModal}})();window.FabOsCredits=FabOsCredits;window.addEventListener("DOMContentLoaded",()=>{FabOsCredits.bindButtons();const close=document.getElementById("fab-os-credits-modal-close");if(close)close.addEventListener("click",FabOsCredits.hideModal)});
